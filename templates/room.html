{% extends 'base.html' %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
<div class="message-box">
  <h2>Chat Room: {{ code }}</h2>
  <div class="messages" id="messages"></div>
  <div class="inputs">
    <input
      type="text"
      placeholder="Message"
      name="message"
      id="message"
      class="message-input"
    />
    <div class="file-input-container">
      <input type="file" id="file-input" accept="image/*,video/*" class="file-input" />
      <button type="button" id="upload-btn" class="upload-btn">Upload File</button>
      <button type="button" id="send-btn" onclick="sendMessage()" class="send-btn">Send</button>
      <button id="audio-btn" class="audio-btn">Record Audio</button>
      <audio id="audioPlayback" controls style="display:none;"></audio>
    </div>
  </div>
</div>

<style>
    .message-input { width: 70%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; }
    .file-input-container { display: flex; align-items: center; }
    .file-input { display: none; }
    .upload-btn, .send-btn, .audio-btn {
        padding: 10px 15px;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .upload-btn { background-color: #007bff; margin-right: 10px; }
    .send-btn { background-color: #28a745; margin-right: 10px; }
    .audio-btn { background-color: #6c757d; }
    .upload-btn:hover { background-color: #0056b3; }
    .send-btn:hover { background-color: #218838; }
    .audio-btn:hover { background-color: #5a6268; }
    .send-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    .message-box { width: 80%; margin: auto; }
    .message-input, .upload-btn, .send-btn, .audio-btn { margin: 5px; }
    .rainbow-text {
        background-image: linear-gradient(90deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #8B00FF);
        -webkit-background-clip: text;
        color: transparent;
        animation: rainbow 1.5s linear infinite;
    }
    @keyframes rainbow {
        from { background-position: 0%; }
        to { background-position: 100%; }
    }
</style>

<script type="text/javascript">
  const socketio = io();
const messageInput = document.getElementById("message");
const recordBtn = document.getElementById("audio-btn");
let mediaRecorder;
let isRecording = false;
let pageIsActive = true;

window.onfocus = () => {
    pageIsActive = true;
    console.log("Window is focused:", pageIsActive);
};
window.onblur = () => {
    pageIsActive = false;
    console.log("Window is not focused:", pageIsActive);
};
Notification.requestPermission()

const createMessage = (name, msg, type, color = '#000000') => {
    const messages = document.getElementById("messages");
    const nameStyle = color === 'rainbow' ? 'rainbow-text' : '';
    const nameColor = color !== 'rainbow' ? `style="color: ${color};"` : '';
    let content = '';

    if (type === 'text') {
        content = `<div><strong class="${nameStyle}" ${nameColor}>${name}</strong>: ${msg}<span class="muted">${new Date().toLocaleString()}</span></div>`;
    } else if (type === 'image' || type === 'audio' || type === 'video') {
        content = `<div><strong class="${nameStyle}" ${nameColor}>${name}</strong>: <br>`;
        if (type === 'image') content += `<img src="${msg}" alt="Image" style="max-width: 100%; height: auto;" />`;
        else if (type === 'video') content += `<video src="${msg}" controls style="max-width: 100%; height: auto;"></video>`;
        else content += `<audio controls src="${msg}"></audio>`;
        content += `<span class="muted">${new Date().toLocaleString()}</span></div>`;
    }

    messages.innerHTML += content;
    messages.scrollTop = messages.scrollHeight;
};

const sendMessage = () => {
    const fileInput = document.getElementById("file-input");
    const message = messageInput.value.trim();

    if (message || fileInput.files.length > 0) {
        if (message) {
            socketio.emit("message", {message: message, type: 'text', color: 'rainbow'});
        }

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            fetch("/upload-file", {method: "POST", body: formData})
                .then(response => response.json())
                .then(data => {
                    if (data.fileUrl) {
                        const type = file.type.startsWith('image/') ? 'image' : file.type.startsWith('video/') ? 'video' : 'audio';
                        socketio.emit("message", {message: data.fileUrl, type: type, color: 'rainbow'});
                    }
                })
                .catch(error => console.error("Error uploading file:", error));
        }

        messageInput.value = "";
        fileInput.value = "";
    }
};

document.getElementById("upload-btn").addEventListener("click", () => {
    document.getElementById("file-input").click();
});

document.getElementById("audio-btn").addEventListener("click", async () => {
    if (isRecording) {
        mediaRecorder.stop();
        return;
    }

    isRecording = true;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
        mediaRecorder = new MediaRecorder(stream);
        const audioChunks = [];

        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
        mediaRecorder.start();

        recordBtn.textContent = "Stop Recording";

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, {type: 'audio/wav'});
            const formData = new FormData();
            formData.append('file', audioBlob, 'audio.wav');

            fetch("/upload-file", {method: "POST", body: formData})
                .then(response => response.json())
                .then(data => {
                    if (data.fileUrl) {
                        socketio.emit("message", {message: data.fileUrl, type: 'audio', color: 'rainbow'});
                    }
                })
                .catch(error => console.error("Error uploading audio:", error))
                .finally(() => {
                    isRecording = false;
                    recordBtn.textContent = "Record Audio";
                });
        };
    } catch (error) {
        console.error("Error capturing audio:", error);
        isRecording = false;
        recordBtn.textContent = "Record Audio";
    }
});

messageInput.addEventListener("keydown", (e) => {
    if (e.code === "Enter" && !messageInput.disabled) {
        sendMessage();
    }
});

socketio.on("message", (data) => {
    createMessage(data.name, data.message, data.type, data.color);
    if (!pageIsActive) {
        showNotification(data.name, data.message);
    }
});


function showNotification(title, body) {
    if (!("Notification" in window)) {
        console.error("This browser does not support desktop notifications");
        return;
    }

    if (Notification.permission === "granted") {
        // Create the notification with the correct title and body
        new Notification(title, { body: body }); // Use title and body here
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(function(permission) {
            if (permission === "granted") {
                // Create the notification if permission is granted *now*
                new Notification(title, { body: body }); // Use title and body here
            }
        });
    }
}
</script>

</body>
</html>
{% endblock %}