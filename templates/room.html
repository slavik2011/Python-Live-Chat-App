{% extends 'base.html' %} 
{% block content %}
<div class="message-box">
  <h2>Chat Room: {{code}}</h2>
  <div class="messages" id="messages"></div>
  <div class="inputs">
    <input type="text" placeholder="Message" name="message" id="message" />
    <input type="file" id="file-input" />
    <button type="button" id="send-btn" onClick="sendMessage()">Send</button>
  </div>
</div>
<script type="text/javascript">
  var socketio = io();

  const messages = document.getElementById("messages");

  const createMessage = (name, msg, imgUrl = null) => {
    let content = `
    <div class="text">
        <span>
            <strong>${name}</strong>: ${msg || ''}
        </span>
        <span class="muted">
            ${new Date().toLocaleString()}
        </span>
    </div>
    `;
    if (imgUrl) {
      content += `<div><img src="${imgUrl}" alt="Image" style="max-width: 200px;"></div>`;
    }
    messages.innerHTML += content;
  };

  socketio.on("message", (data) => {
    createMessage(data.name, data.message, data.imgUrl);
  });

  const sendMessage = () => {
    const message = document.getElementById("message").value;
    const fileInput = document.getElementById("file-input");
    const file = fileInput.files[0];

    if (message == "" && !file) return;

    if (file) {
      const formData = new FormData();
      formData.append("file", file);
      fetch("/upload-image", {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          socketio.emit("message", { message, imgUrl: data.imgUrl });
        })
        .catch((error) => console.error("Error uploading image:", error));
    } else {
      socketio.emit("message", { message });
    }

    document.getElementById("message").value = "";
    fileInput.value = "";
  };

  document.getElementById("message").addEventListener("keydown", function (e) {
    if (e.code === "Enter") {
      sendMessage();
    }
  });
</script>
{% endblock %}
