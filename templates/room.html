{% extends 'base.html' %} 
{% block content %}
<div class="message-box">
  <h2>Chat Room: {{ code }}</h2>
  <div class="messages" id="messages"></div>
  <div class="inputs">
    <input type="text" rows="3" placeholder="Message" name="message" id="message" />
    <input type="file" id="fileInput" />
    <button type="button" id="send-btn" onClick="sendOrUpload()">Send/Upload</button>
  </div>
</div>

<script type="text/javascript">
  var socketio = io();
  const messages = document.getElementById("messages");

  const createMessage = (name, msg, type) => {
    let content = `
    <div class="text">
        <span><strong>${name}</strong>: `;
    
    if (type === 'text') {
      content += msg;
    } else if (type === 'image') {
      content += `<img src="${msg}" alt="Uploaded Image" style="max-width: 300px; max-height: 300px;" />`;
    } else if (type === 'video') {
      content += `<video controls style="max-width: 300px; max-height: 300px;">
                    <source src="${msg}" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>`;
    }

    content += `</span>
        <span class="muted">${new Date().toLocaleString()}</span>
    </div>`;
    messages.innerHTML += content;
  };

  socketio.on("message", (data) => {
    createMessage(data.name, data.message, data.type);
  });

  const sendOrUpload = () => {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    const message = document.getElementById("message").value;

    if (file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("message", message);

      fetch("/upload-file", {
        method: "POST",
        body: formData,
      })
      .then(response => response.json())
      .then(data => {
        if (data.fileUrl) {
          // Emit the file URL to the socket
          socketio.emit("message", { name: '{{ session["name"] }}', message: data.fileUrl, type: data.fileType });
          // Clear the file input and message input
          fileInput.value = "";
          document.getElementById("message").value = "";
        } else {
          console.error("Upload error:", data.error);
        }
      })
      .catch(error => {
        console.error("Error uploading file:", error);
      });
    } else if (message) {
      // If no file, just send the message
      socketio.emit("message", { name: '{{ session["name"] }}', message: message, type: 'text' });
      document.getElementById("message").value = ""; // Clear the message input
    }
  };

  // Optional: Add event listener for Enter key
  document.getElementById("message").addEventListener("keydown", function (e) {
    if (e.code === "Enter") {
      sendOrUpload();
    }
  });
</script>
{% for msg in messages %}
<script type="text/javascript">
  createMessage("{{ msg.name }}", "{{ msg.message }}", "{{ msg.type }}");
</script>
{% endfor %}
{% endblock %}
